<script>
const out = document.getElementById("out");
const btn = document.getElementById("btn");

function pretty(obj) {
  try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
}

btn.onclick = async () => {
  out.textContent = "Uploading...";
  btn.disabled = true;

  try {
    const token = document.getElementById("token").value.trim();
    const owner = document.getElementById("owner").value.trim();
    const repo = document.getElementById("repo").value.trim();
    const branch = (document.getElementById("branch").value.trim() || "main");
    const basePath = document.getElementById("basePath").value.trim();
    const message = (document.getElementById("msg").value.trim() || "Upload via web uploader");
    const filesEl = document.getElementById("files");

    if (!token || !owner || !repo) {
      out.textContent = "Token/Owner/Repo wajib diisi.";
      return;
    }
    if (!filesEl.files.length) {
      out.textContent = "Pilih minimal 1 file.";
      return;
    }

    const fd = new FormData();
    fd.append("token", token);
    fd.append("owner", owner);
    fd.append("repo", repo);
    fd.append("branch", branch);
    fd.append("basePath", basePath);
    fd.append("message", message);

    for (const f of filesEl.files) fd.append("files", f, f.name);

    const res = await fetch("/upload", { method: "POST", body: fd });

    const ct = res.headers.get("content-type") || "";
    const body = ct.includes("application/json") ? await res.json() : await res.text();

    if (!res.ok) {
      out.textContent = `HTTP ${res.status}\n` + (typeof body === "string" ? body : pretty(body));
      return;
    }

    out.textContent = typeof body === "string" ? body : pretty(body);
  } catch (e) {
    // "Failed to fetch" biasanya: server down / koneksi putus / DNS / HTTPS mixed content
    out.textContent =
      `FAILED TO FETCH\n` +
      `Kemungkinan: jaringan putus, tab reload/ketutup, server heroku lagi restart, atau request terlalu lama.\n\n` +
      `Detail: ${e?.message || e}`;
  } finally {
    btn.disabled = false;
  }
};
                                            </script>
